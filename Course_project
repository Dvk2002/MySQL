CREATE DATABASE li_chess;


CREATE TABLE users(
id int  AUTO_INCREMENT PRIMARY KEY,
name varchar(255)
);


CREATE TABLE profile(
user_id int,
country varchar(256),
location varchar(256),
user_rating int,
email varchar(256) UNIQUE NOT NULL,
created_at datetime DEFAULT CURRENT_TIMESTAMP
);


CREATE TABLE games(
id int  AUTO_INCREMENT PRIMARY KEY,
type_game_id int,
white int NOT NULL  comment'user_id',
black int NOT NULL  comment 'user_id',
status_id int,
result_game float UNSIGNED comment '1 - white winner, 0- black winner, 0,5 - draw',
tournament_id int,
start_at datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
finished_at datetime NOT NULL DEFAULT CURRENT_TIMESTAMP
);


CREATE TABLE status_game(
id int  AUTO_INCREMENT PRIMARY KEY,
name varchar(256)
);

CREATE TABLE types_game(
id int  AUTO_INCREMENT PRIMARY KEY,
name varchar(256),
game_time time
);

CREATE TABLE tournaments(
id int  AUTO_INCREMENT PRIMARY KEY,
name varchar (256),
type_game_id int,
club_id int,
start_at datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
finished_at datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
status_id int,
winner_id int);

CREATE TABLE messages (
id int  AUTO_INCREMENT PRIMARY KEY,
from_user_id int,
to_user_id int,
body TEXT (65535),
created_at timestamp DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE clubs(
id int  AUTO_INCREMENT PRIMARY KEY,
name varchar (150),
created_at timestamp DEFAULT CURRENT_TIMESTAMP,
is_closed bool
);

CREATE TABLE clubs_members(
club_id int,
user_id int,
is_admin bool,
is_banned bool
);

CREATE TABLE subscribes (
user_id int not null,
to_user_id int not null
);

CREATE TABLE languages (
id int AUTO_INCREMENT PRIMARY KEY,
name varchar(256)
);

CREATE TABLE speak_languages(
id int AUTO_INCREMENT PRIMARY KEY,
language_id int,
trainer_id int
);

CREATE TABLE trainers (
id int AUTO_INCREMENT PRIMARY KEY,
name varchar(256) NOT NULL,
rating int,
location varchar(256),
ratio_for_hour int,
availibility bool
);

CREATE TABLE boards (
id int AUTO_INCREMENT PRIMARY KEY,
name varchar(16),
board JSON
);


CREATE TABLE figures_types (
id int AUTO_INCREMENT PRIMARY KEY,
name varchar(16),
figures_type JSON
);


CREATE TABLE theams(
id int AUTO_INCREMENT PRIMARY KEY,
name varchar(16), 
theam JSON
);

DROP TABLE figures;
CREATE TABLE figures(
id int AUTO_INCREMENT PRIMARY KEY,
name varchar(16),
shot_name varchar(16),
pict json
);

CREATE TABLE settings(
id int AUTO_INCREMENT PRIMARY KEY,
user_id int,
boards_id int,
language_id int,
figures_type_id int,
theam_id int
);

CREATE TABLE moves (
game_id int NOT NULL,
move_number int,
user_id int NOT NULL,
figure_id int,
`field` int
);


-- Вставка значений --

INSERT INTO figures(name, shot_name) VALUES
('king', 'K'), ('queen','Q'), ('rook','R'), ('knight','N'),('bishop','B'),('pawn','P');

INSERT INTO theams(name) VALUES
('Dark'), ('Light'), ('Shapes'),('Anthracite'), ('Blue Maze'),('Red Maze'), ('Wood');

INSERT INTO languages(name) VALUES
('English'), ('French'), ('German'),('Russian'), ('Spain'),('Chinese'), ('Italian');

INSERT INTO boards(name) VALUES
('Brown'), ('Blue'), ('Grey'),('Purple'), ('Wood'),('Maple');

INSERT INTO figures_types(name) VALUES
('Merida'), ('Pirouetti'), ('Alpha'),('Spatial'), ('Companion'),('Leipzig');

UPDATE games g,(SELECT t.start_a, t.id as id 
FROM games g 
LEFT JOIN tournaments t on t.id = g.type_game_id)
as s
SET g.start_at = s.start_at 
WHERE s.id = g.type_game_id;

UPDATE status_game SET name ='not_started' WHERE id = 1;
UPDATE status_game SET name ='playing' WHERE id = 2;
UPDATE status_game SET name ='finished' WHERE id = 3;

UPDATE types_game SET name = 'bullet', game_time = '0:03:00' WHERE id = 1;
UPDATE types_game SET name = 'blitz', game_time = '0:05:00' WHERE id = 2;
UPDATE types_game SET name = 'rapid', game_time = '0:10:00' WHERE id = 3;
UPDATE types_game SET name = 'classical', game_time = '0:15:00' WHERE id = 4;
UPDATE types_game SET name = 'custom' WHERE id = 5;

UPDATE games SET white = white+3 WHERE white = black;
UPDATE games SET finished_at = start_at + INTERVAL 3*1.8 MINUTE  WHERE type_game_id = 1;
UPDATE games SET finished_at = start_at + INTERVAL 5*1.8 MINUTE  WHERE type_game_id = 2;
UPDATE games SET finished_at = start_at + INTERVAL 10*1.8 MINUTE  WHERE type_game_id = 3;
UPDATE games SET finished_at = start_at + INTERVAL 15*1.8 MINUTE  WHERE type_game_id = 4;
UPDATE games SET finished_at = start_at + INTERVAL 3 HOUR  WHERE type_game_id = 5;
UPDATE games SET result_game = 0.5 WHERE result_game = 5;

UPDATE messages SET from_user_id = from_user_id+3 WHERE from_user_id = to_user_id;
UPDATE subscribes SET user_id = user_id + 1 WHERE user_id = to_user_id;



-- Ограничения --

ALTER TABLE clubs_members ADD CONSTRAINT clubs_members_club_id_fk FOREIGN KEY (club_id) REFERENCES clubs(id);
ALTER TABLE clubs_members ADD CONSTRAINT clubs_members_user_id_fk FOREIGN KEY (user_id) REFERENCES users(id);

ALTER TABLE tournaments ADD CONSTRAINT tournaments_type_game_id_fk FOREIGN KEY (type_game_id) REFERENCES types_game(id);
ALTER TABLE tournaments ADD CONSTRAINT tournaments_club_id_fk FOREIGN KEY (club_id) REFERENCES clubs(id);
ALTER TABLE tournaments ADD CONSTRAINT tournaments_status_id_fk FOREIGN KEY (status_id) REFERENCES status_game(id);
ALTER TABLE tournaments ADD CONSTRAINT tournaments_winner_id_fk FOREIGN KEY (winner_id) REFERENCES users(id);


ALTER TABLE games ADD CONSTRAINT games_type_game_id_fk FOREIGN KEY (type_game_id) REFERENCES types_game(id);
ALTER TABLE games ADD CONSTRAINT games_white_fk FOREIGN KEY (white) REFERENCES users(id);
ALTER TABLE games ADD CONSTRAINT games_black_fk FOREIGN KEY (black) REFERENCES users(id);
ALTER TABLE games ADD CONSTRAINT games_status_id_fk FOREIGN KEY (status_id) REFERENCES status_game(id);
ALTER TABLE games ADD CONSTRAINT games_tournament_id_fk FOREIGN KEY (tournament_id) REFERENCES tournaments(id);

ALTER TABLE messages ADD CONSTRAINT messages_from_user_id_fk FOREIGN KEY (from_user_id) REFERENCES users(id);
ALTER TABLE messages ADD CONSTRAINT messages_to_user_id_fk FOREIGN KEY (to_user_id) REFERENCES users(id);

ALTER TABLE moves ADD CONSTRAINT moves_user_id_fk FOREIGN KEY (user_id) REFERENCES users(id);
ALTER TABLE moves ADD CONSTRAINT moves_figure_id_fk FOREIGN KEY (figure_id) REFERENCES figures(id);
ALTER TABLE moves ADD CONSTRAINT moves_game_id_fk FOREIGN KEY (game_id) REFERENCES games(id);

ALTER TABLE profile ADD  CONSTRAINT profile_white_fk FOREIGN KEY (user_id) REFERENCES users(id);

ALTER TABLE settings ADD CONSTRAINT settings_user_id_fk FOREIGN KEY (user_id) REFERENCES users(id);
ALTER TABLE settings ADD CONSTRAINT settings_board_id_fk FOREIGN KEY (board_id) REFERENCES boards(id);
ALTER TABLE settings ADD CONSTRAINT settings_language_id_fk FOREIGN KEY (language_id) REFERENCES languages(id);
ALTER TABLE settings ADD CONSTRAINT settings_figures_type_id_fk FOREIGN KEY (figures_type_id) REFERENCES figures_types(id);
ALTER TABLE settings ADD CONSTRAINT settings_theam_id_fk FOREIGN KEY (theam_id) REFERENCES theams(id);

ALTER TABLE subscribes ADD CONSTRAINT subscribes_user_id_fk FOREIGN KEY (user_id) REFERENCES users(id);
ALTER TABLE subscribes ADD CONSTRAINT subscribes_to_user_id_fk FOREIGN KEY (to_user_id) REFERENCES users(id);
ALTER TABLE subscribes ADD CONSTRAINT PRIMARY KEY (user_id,to_user_id);

ALTER TABLE speak_languages ADD CONSTRAINT speak_languages_trainer_id_fk FOREIGN KEY (trainer_id) REFERENCES trainers(id);
ALTER TABLE speak_languages ADD CONSTRAINT speak_languages_language_id_fk FOREIGN KEY (language_id) REFERENCES languages(id);
